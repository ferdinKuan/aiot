<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>AIoT å¿ƒæƒ…æ¨è–¦ç³»çµ±</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { height: 400px; width: 100%; margin-top: 20px; }
    </style>
</head>
<body>
    <h2>è«‹è¼¸å…¥ä½ ä»Šå¤©çš„æ„Ÿå—</h2>

    <textarea id="userInput" rows="5" cols="50" placeholder="ä¾‹å¦‚ï¼šæˆ‘ä»Šå¤©å£“åŠ›å¾ˆå¤§..."></textarea><br>
    <button onclick="analyze()">åˆ†æå¿ƒæƒ…</button>

    <h3>çµæœï¼š</h3>
    <div id="result"></div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map;
        let markers = [];

        function initMap() {
            if (!map) {
                map = L.map('map').setView([24.1477, 120.6736], 13); // é è¨­ä¸­å¿ƒï¼šå°ä¸­

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Map data Â© OpenStreetMap contributors'
                }).addTo(map);

                // â¬‡ï¸ åŠ ä¸Šå®šä½åŠŸèƒ½
                map.locate({ setView: true, maxZoom: 16 });

                map.on('locationfound', function (e) {
                L.marker(e.latlng).addTo(map)
                    .bindPopup("ğŸ“ ä½ åœ¨é€™è£¡").openPopup();
                });

                map.on('locationerror', function (e) {
                alert("â— ç„¡æ³•å–å¾—æ‚¨çš„ä½ç½®ï¼Œè«‹ç¢ºèªç€è¦½å™¨å®šä½å·²é–‹å•Ÿã€‚");
                });
            }

            // æ¸…é™¤èˆŠæ¨™è¨˜ï¼ˆä½ çš„åŸæœ¬ç¨‹å¼ç¢¼ï¼‰
            markers.forEach(m => map.removeLayer(m));
            markers = [];
        }


        async function analyze() {
            const text = document.getElementById("userInput").value;

            // å–å¾—ä½¿ç”¨è€…ä½ç½®
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const user_lat = pos.coords.latitude;
                const user_lng = pos.coords.longitude;

                const response = await fetch("/analyze", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        text: text,
                        user_lat: user_lat,
                        user_lng: user_lng
                    })
                });
            

            const data = await response.json();

            // é¡¯ç¤ºåˆ†æçµæœ
            document.getElementById("result").innerHTML = `
                ğŸ§  å¿ƒæƒ…åˆ¤æ–·ï¼š<strong>${data.mood}</strong><br>
                ğŸ”‘ é—œéµå­—ï¼š${data.keywords.join(", ")}<br><br>
                <strong>ğŸœ æ¨è–¦é¤å»³ï¼š</strong><br>
                ${data.recommendations.length > 0 
                    ? data.recommendations.map(r => `
                    â˜• ${r.name}ï¼ˆ${r.type}ï¼Œ${r.price_level}ï¼‰<br>
                    â¤ mood tags: ${r.mood_tags}<br><br>
                    `).join('')
                : 'æ‰¾ä¸åˆ°ç¬¦åˆçš„æ¨è–¦é¤å»³'}
            `;

             // é¡¯ç¤ºåœ°åœ–
            initMap();
            data.recommendations.forEach(r => {
                const marker = L.marker([r.latitude, r.longitude])
                    .addTo(map)
                    .bindPopup(`<b>${r.name}</b><br>${r.type}ï¼Œ${r.price_level}<br>ğŸ§  mood: ${r.mood_tags}`);
                    markers.push(marker);
            });

            // èšç„¦ç¬¬ä¸€ç­†æ¨è–¦åœ°é»
            if (data.recommendations.length > 0) {
                const center = [data.recommendations[0].latitude, data.recommendations[0].longitude];
                map.setView(center, 15);
            }

            }, (err) => {
                alert("âš ï¸ è«‹å…è¨±ç€è¦½å™¨å–å¾—æ‚¨çš„ä½ç½®ï¼Œæ‰èƒ½æ¨è–¦é™„è¿‘åœ°é»ï¼");
            });
        }
    </script>
</body>
</html>
